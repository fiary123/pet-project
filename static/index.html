<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI æ™ºèƒ½å® ç‰©ç”Ÿæ€ç³»ç»Ÿ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background-color: #f4f6f8; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        
        /* å¯¼èˆªæ æ ·å¼ */
        .navbar { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .navbar-brand, .nav-link { color: white !important; font-weight: 500; }
        .nav-link:hover { opacity: 0.8; }
        
        /* å¡ç‰‡é€šç”¨æ ·å¼ */
        .pet-card, .social-card {
            border: none; border-radius: 15px; overflow: hidden; background: white;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05); transition: transform 0.2s;
            margin-bottom: 20px;
        }
        .pet-card:hover { transform: translateY(-5px); }
        .card-img-top { height: 220px; object-fit: cover; }
        
        /* ç¤¾äº¤åŠ¨æ€æ ·å¼ */
        .social-header { padding: 15px; display: flex; align-items: center; border-bottom: 1px solid #eee; }
        .user-avatar { width: 40px; height: 40px; background: #ddd; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 10px; color: #666; }
        
        /* èŠå¤©çª—å£æ ·å¼ */
        .chat-box { height: 350px; overflow-y: auto; background: #f9f9f9; padding: 15px; border-radius: 10px; border: 1px solid #eee; }
        .message { margin-bottom: 15px; max-width: 80%; padding: 10px 15px; border-radius: 20px; font-size: 0.9rem; }
        .msg-user { background: #667eea; color: white; margin-left: auto; border-bottom-right-radius: 5px; }
        .msg-ai { background: white; color: #333; border: 1px solid #ddd; border-bottom-left-radius: 5px; }

        /* æµ®åŠ¨æŒ‰é’® (å‘å¸ƒ) */
        .fab-btn {
            position: fixed; bottom: 30px; right: 30px;
            width: 60px; height: 60px; border-radius: 50%;
            background: #764ba2; color: white; border: none;
            box-shadow: 0 4px 15px rgba(118, 75, 162, 0.4);
            font-size: 24px; display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: transform 0.2s; z-index: 1000;
        }
        .fab-btn:hover { transform: scale(1.1); }
    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg sticky-top">
        <div class="container">
            <a class="navbar-brand" href="#"><i class="fas fa-paw me-2"></i>AI å® çˆ±</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item"><a class="nav-link" href="#" onclick="switchTab('home')">ğŸ¶ æœå® å¹¿åœº</a></li>
                    <li class="nav-item"><a class="nav-link" href="#" onclick="switchTab('social')">ğŸ“± ç¤¾åŒºåŠ¨æ€</a></li>
                </ul>
                <div class="d-flex" id="authSection">
                    </div>
            </div>
        </div>
    </nav>

    <div class="container py-4">

        <div id="homeTab">
            <div class="row justify-content-center mb-5">
                <div class="col-md-8">
                    <div class="input-group input-group-lg shadow-sm rounded-pill overflow-hidden">
                        <input type="text" id="searchInput" class="form-control border-0 ps-4" placeholder="æè¿°ä½ æ¢¦ä¸­çš„å® ç‰© (ä¾‹å¦‚: 'ç¡è§‰çš„å°çŒ«')...">
                        <button class="btn btn-primary px-4" style="background: #764ba2; border:none" onclick="searchPets()">
                            <i class="fas fa-search"></i> æœç´¢
                        </button>
                    </div>
                </div>
            </div>
            <div class="row" id="petsGrid">
                <div class="text-center text-muted mt-5">
                    <i class="fas fa-arrow-up fa-2x mb-3"></i><br>è¾“å…¥å…³é”®è¯ï¼Œå¼€å§‹å¯»æ‰¾ä½ çš„ç¼˜åˆ†
                </div>
            </div>
        </div>

        <div id="socialTab" class="d-none">
            <div class="row justify-content-center">
                <div class="col-md-6" id="socialFeed">
                    <div class="text-center py-5"><div class="spinner-border text-primary"></div></div>
                </div>
            </div>
        </div>

    </div>

    <button class="fab-btn d-none" id="fabBtn" data-bs-toggle="modal" data-bs-target="#publishModal">
        <i class="fas fa-plus"></i>
    </button>

    <div class="modal fade" id="authModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header border-0">
                    <h5 class="modal-title" id="authTitle">ç”¨æˆ·ç™»å½•</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="authForm">
                        <div class="mb-3">
                            <label>é‚®ç®±è´¦å·</label>
                            <input type="email" class="form-control" id="authEmail" required>
                        </div>
                        <div class="mb-3">
                            <label>å¯†ç </label>
                            <input type="password" class="form-control" id="authPwd" required>
                        </div>
                        <div class="mb-3 d-none" id="registerFields">
                            <label>æ˜µç§°</label>
                            <input type="text" class="form-control" id="authName">
                            <label class="mt-2">èº«ä»½</label>
                            <select class="form-select" id="authRole">
                                <option value="user">æ™®é€šç”¨æˆ·</option>
                                <option value="admin">ç®¡ç†å‘˜ (æ•‘åŠ©ç«™)</option>
                            </select>
                        </div>
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary" style="background: #667eea; border:none">ç¡®è®¤</button>
                        </div>
                    </form>
                    <div class="text-center mt-3">
                        <a href="#" class="small text-decoration-none" onclick="toggleAuthMode()">åˆ‡æ¢ ç™»å½• / æ³¨å†Œ</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="chatModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-light">
                    <h5 class="modal-title"><i class="far fa-comments me-2"></i>ä¸ <span id="chatPetName">å® ç‰©</span> å¯¹è¯</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="chat-box" id="chatHistory">
                        <div class="text-center text-muted small my-3">-- å¼€å¯ä¸€æ®µæ–°çš„å¯¹è¯ --</div>
                    </div>
                    <div class="input-group mt-3">
                        <input type="text" id="chatInput" class="form-control" placeholder="è¯´ç‚¹ä»€ä¹ˆ...">
                        <button class="btn btn-primary" onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="publishModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">å‘å¸ƒå†…å®¹</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <ul class="nav nav-tabs mb-3">
                        <li class="nav-item">
                            <a class="nav-link active" href="#" onclick="setPublishType('social')">å‘åŠ¨æ€</a>
                        </li>
                        <li class="nav-item" id="adminTab">
                            <a class="nav-link" href="#" onclick="setPublishType('pet')">å‘å¸ƒé¢†å…» (Admin)</a>
                        </li>
                    </ul>
                    <form id="publishForm">
                        <input type="hidden" id="publishType" value="social">
                        <div class="mb-3">
                            <label>æ–‡å­—æè¿°</label>
                            <textarea class="form-control" id="pubContent" rows="3" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label>ä¸Šä¼ ç…§ç‰‡</label>
                            <input type="file" class="form-control" id="pubFile" accept="image/*" required>
                        </div>
                        
                        <div id="petFields" class="d-none">
                            <div class="row">
                                <div class="col-6 mb-3">
                                    <label>å® ç‰©åå­—</label>
                                    <input type="text" class="form-control" id="pubName">
                                </div>
                                <div class="col-6 mb-3">
                                    <label>å“ç§</label>
                                    <input type="text" class="form-control" id="pubBreed">
                                </div>
                            </div>
                        </div>
                        
                        <div class="d-grid">
                            <button type="submit" class="btn btn-success">ç«‹å³å‘å¸ƒ</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // å…¨å±€çŠ¶æ€
        let currentUser = null;
        let token = localStorage.getItem('pet_token');
        let currentPetId = null;

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            checkLogin();
            loadFeed(); // é¢„åŠ è½½ç¤¾åŒº
            loadInitialPets(); // é¢„åŠ è½½å® ç‰©å¹¿åœº
            
            // ç»‘å®šå›è½¦å‘é€
            document.getElementById('chatInput').addEventListener('keypress', (e) => {
                if(e.key === 'Enter') sendMessage();
            });
        });

        // ================= 1. è®¤è¯é€»è¾‘ =================
        // ... (ä¿æŒä¸å˜)

        // ================= 3. æœå® åŠŸèƒ½ =================
        async function loadInitialPets() {
            const grid = document.getElementById('petsGrid');
            try {
                const res = await fetch('/pets/initial');
                const data = await res.json();
                renderPets(data, grid);
            } catch(e) {
                grid.innerHTML = '<div class="text-center text-muted">åŠ è½½æ¨èå® ç‰©å¤±è´¥</div>';
            }
        }

        async function searchPets() {
            const query = document.getElementById('searchInput').value;
            if(!query) { loadInitialPets(); return; }
            
            const grid = document.getElementById('petsGrid');
            grid.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary"></div></div>';

            try {
                const res = await fetch('/search', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({query})
                });
                const data = await res.json();
                renderPets(data, grid);
            } catch(e) {
                console.error(e);
                grid.innerHTML = '<div class="alert alert-danger">æœç´¢å‡ºé”™</div>';
            }
        }

        function renderPets(data, grid) {
            grid.innerHTML = '';
            if(data.length === 0) {
                grid.innerHTML = '<div class="text-center text-muted">æœªæ‰¾åˆ°åŒ¹é…çš„å® ç‰©</div>';
                return;
            }

            data.forEach(pet => {
                const imgUrl = pet.image_url.replace('./images', '/images');
                const chatBtn = currentUser 
                    ? `<button class="btn btn-sm btn-outline-primary rounded-pill" onclick="openChat('${pet.name}', ${pet.id})"><i class="far fa-comments"></i> èŠèŠ</button>` 
                    : `<span class="badge bg-secondary">ç™»å½•åèŠå¤©</span>`;

                grid.innerHTML += `
                    <div class="col-md-4 col-sm-6 mb-4">
                        <div class="card pet-card h-100">
                            <div class="position-relative">
                                <img src="${imgUrl}" class="card-img-top">
                                ${pet.score < 1.0 ? `<span class="badge bg-dark position-absolute top-0 end-0 m-2">ç›¸ä¼¼åº¦ ${(pet.score*100).toFixed(0)}%</span>` : ''}
                            </div>
                            <div class="card-body">
                                <h5 class="card-title fw-bold">${pet.name}</h5>
                                <p class="card-text text-muted small">${pet.description}</p>
                                <div class="d-flex justify-content-between align-items-center mt-3">
                                    ${chatBtn}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
        }

        // ================= 4. ç¤¾åŒº Feed =================
        async function loadFeed() {
            const container = document.getElementById('socialFeed');
            try {
                // éœ€è¦ Token æ‰èƒ½çœ‹ Feed å—ï¼Ÿä»£ç é‡Œ get_feed ä¾èµ– get_current_user
                // æ‰€ä»¥å¿…é¡»ç™»å½•
                if (!token) {
                    container.innerHTML = '<div class="text-center py-5"><h3>ğŸ”’</h3><p>è¯·å…ˆç™»å½•æŸ¥çœ‹ç¤¾åŒºåŠ¨æ€</p></div>';
                    return;
                }

                const res = await fetch('/social/feed', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const posts = await res.json();
                
                container.innerHTML = '';
                posts.forEach(post => {
                    const imgUrl = post.image_url.replace('./images', '/images');
                    container.innerHTML += `
                        <div class="card social-card">
                            <div class="social-header">
                                <div class="user-avatar"><i class="fas fa-user"></i></div>
                                <div>
                                    <div class="fw-bold">${post.username}</div>
                                    <div class="text-muted small">åˆšåˆš</div>
                                </div>
                            </div>
                            <img src="${imgUrl}" class="img-fluid" style="max-height:400px; object-fit:cover;">
                            <div class="card-body">
                                <p class="card-text">${post.content}</p>
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="text-muted small"><i class="far fa-heart"></i> ${post.likes} èµ</div>
                                    <button class="btn btn-sm btn-link text-decoration-none" onclick="toggleComments(${post.id})">
                                        <i class="far fa-comment"></i> è¯„è®º
                                    </button>
                                </div>
                                
                                <div id="comments-section-${post.id}" class="d-none mt-3 pt-3 border-top">
                                    <div id="comments-list-${post.id}" class="mb-3">
                                        <!-- Comments will load here -->
                                        <div class="text-center text-muted small">åŠ è½½è¯„è®ºä¸­...</div>
                                    </div>
                                    <div class="input-group input-group-sm">
                                        <input type="text" id="comment-input-${post.id}" class="form-control" placeholder="å†™ä¸‹ä½ çš„è¯„è®º...">
                                        <button class="btn btn-outline-primary" onclick="postComment(${post.id})">å‘é€</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
            } catch(e) {
                container.innerHTML = '<div class="text-center text-muted">åŠ è½½åŠ¨æ€å¤±è´¥</div>';
            }
        }

        async function toggleComments(postId) {
            const section = document.getElementById(`comments-section-${postId}`);
            const isHidden = section.classList.contains('d-none');
            
            if (isHidden) {
                section.classList.remove('d-none');
                await loadComments(postId);
            } else {
                section.classList.add('d-none');
            }
        }

        async function loadComments(postId) {
            const list = document.getElementById(`comments-list-${postId}`);
            try {
                const res = await fetch(`/social/posts/${postId}/comments`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const comments = await res.json();
                
                if (comments.length === 0) {
                    list.innerHTML = '<div class="text-muted small ps-2">æš‚æ— è¯„è®ºï¼Œå¿«æ¥æŠ¢æ²™å‘~</div>';
                    return;
                }

                list.innerHTML = comments.map(c => `
                    <div class="mb-2">
                        <span class="fw-bold small">${c.username}:</span>
                        <span class="small">${c.content}</span>
                    </div>
                `).join('');
            } catch (e) {
                list.innerHTML = '<div class="text-danger small">åŠ è½½å¤±è´¥</div>';
            }
        }

        async function postComment(postId) {
            const input = document.getElementById(`comment-input-${postId}`);
            const content = input.value.trim();
            if (!content) return;

            try {
                const res = await fetch(`/social/posts/${postId}/comments`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}` 
                    },
                    body: JSON.stringify({ content })
                });

                if (res.ok) {
                    input.value = '';
                    await loadComments(postId);
                } else {
                    alert('è¯„è®ºå¤±è´¥');
                }
            } catch (e) {
                console.error(e);
                alert('ç½‘ç»œé”™è¯¯');
            }
        }

        // ================= 5. èŠå¤©åŠŸèƒ½ =================
        function openChat(name, id) {
            if(!id) { alert("è¯¥å® ç‰©æ•°æ®ç¼ºå¤±IDï¼Œæ— æ³•èŠå¤©"); return; }
            currentPetId = id;
            document.getElementById('chatPetName').innerText = name;
            document.getElementById('chatHistory').innerHTML = '<div class="text-center text-muted small my-3">-- è®°å¿†å·²åŠ è½½ --</div>';
            new bootstrap.Modal(document.getElementById('chatModal')).show();
        }

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const msg = input.value;
            if(!msg) return;

            // æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
            appendMsg('user', msg);
            input.value = '';

            try {
                const res = await fetch('/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ pet_id: currentPetId, user_msg: msg })
                });
                const data = await res.json();
                appendMsg('ai', data.reply);
            } catch(e) {
                appendMsg('ai', "ç½‘ç»œé”™è¯¯...");
            }
        }

        function appendMsg(role, text) {
            const box = document.getElementById('chatHistory');
            const div = document.createElement('div');
            div.className = `message ${role === 'user' ? 'msg-user' : 'msg-ai'}`;
            div.innerText = text;
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
        }

        // ================= 6. å‘å¸ƒåŠŸèƒ½ =================
        let pubType = 'social';
        function setPublishType(type) {
            pubType = type;
            document.getElementById('publishType').value = type;
            document.getElementById('petFields').classList.toggle('d-none', type !== 'pet');
            // åˆ‡æ¢ Tab æ ·å¼
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            event.target.classList.add('active');
        }

        document.getElementById('publishForm').onsubmit = async (e) => {
            e.preventDefault();
            const formData = new FormData();
            const fileField = document.getElementById('pubFile');
            
            formData.append('file', fileField.files[0]);
            formData.append('description', document.getElementById('pubContent').value); // å¤ç”¨å­—æ®µ

            let url = '';
            if (pubType === 'social') {
                url = '/social/post';
                formData.append('content', document.getElementById('pubContent').value);
            } else {
                url = '/publish'; // Admin only
                formData.append('name', document.getElementById('pubName').value);
                formData.append('breed', document.getElementById('pubBreed').value);
            }

            try {
                const res = await fetch(url, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` },
                    body: formData
                });
                
                if(!res.ok) {
                    if(res.status === 403) throw new Error("æƒé™ä¸è¶³ï¼šåªæœ‰ç®¡ç†å‘˜å¯ä»¥å‘å¸ƒé¢†å…»ä¿¡æ¯");
                    throw new Error("å‘å¸ƒå¤±è´¥");
                }
                
                alert("å‘å¸ƒæˆåŠŸï¼åå°æ­£åœ¨å¤„ç†AIæ•°æ®...");
                bootstrap.Modal.getInstance(document.getElementById('publishModal')).hide();
                if(pubType === 'social') switchTab('social');
                
            } catch(e) {
                alert(e.message);
            }
        };
    </script>
</body>
</html>